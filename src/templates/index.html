<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Perdisco Flashcards Tool</title>
  <!-- Polyfill -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <!-- MathJax configuration -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    };
  </script>
  <!-- MathJax for LaTeX rendering -->
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <!-- Simple CSS styling -->
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: #eef;
    }
    .flashcard {
      margin: 20px auto;
      padding: 20px;
      border: 2px solid #ccc;
      width: 60%;
      min-height: 150px;
      max-width: 500px;
      /* align-items: center; */
      text-align: left;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 12px rgba(0,0,0,0.1);
      font-size: 1.5em;
    }
    .flashcard img {
      max-width: 500px;
      max-height: 150px;
      /* Optionally, add margin or display properties if desired */
    }
    #card-info, #extra-info, #tags-info {
      margin-top: 10px;
      font-size: 1.2em;
      color: #555;
    }
    #controls {
      margin: 20px auto;
      width: 60%;
    }
    #controls input, #controls button {
      font-size: 1em;
      padding: 5px 10px;
    }
    .slider-container {
      margin-top: 10px;
    }
    /* Ensure MathJax inline math renders inline with the text */
    mjx-container[jax="CHTML"] {
      display: inline !important;
      vertical-align: baseline !important;
      margin: 0 !important;
      padding: 0 !important;
      font-size: 1em !important;
    }
  </style>
</head>
<body>
  <!-- Tag Filter Section -->
  <div id="controls">
    <label for="tag-filter">Filter by Tag:</label>
    <input type="text" id="tag-filter" placeholder="Enter tag (e.g., 16.32)">
    <button id="apply-filter">Apply Filter</button>
    <button id="clear-filter">Clear Filter</button>
    <!-- Edit Mode Toggle Button -->
    <button id="toggle-edit">Edit Card</button>
  </div>

  <!-- Flashcard Display -->
  <div class="flashcard" id="flashcard"></div>
  <div id="card-info"></div>
  
  <!-- Extra Info about the card -->
  <div id="extra-info"></div>

  <!-- Importance Slider -->
  <div class="slider-container">
    <label for="importance-slider" style="font-size: 1.2em; color: #555;">Importance (0-10): </label>
    <input type="range" id="importance-slider" min="0" max="10" value="0">
    <span id="importance-value" style="font-size: 1.2em; color: #555;">0</span>
    <button id="save-importance">Save</button>
  </div>

  <!-- Understanding Slider -->
  <div class="slider-container">
    <label for="understanding-slider" style="font-size: 1.2em; color: #555;">Understanding (0-10): </label>
    <input type="range" id="understanding-slider" min="0" max="10" value="0">
    <span id="understanding-value" style="font-size: 1.2em; color: #555;">0</span>
    <button id="save-understanding">Save</button>
  </div>

  <!-- Tag info about the card -->
  <div id="tags-info"></div>

  <script>
    // Flashcards data passed from Flask
    const allFlashcards = {{ flashcards | tojson }};
    let flashcards = allFlashcards.slice(); // current filtered list
    let currentIndex = 0;
    let showingFront = true;
    let editMode = false; // New variable for edit mode

    // Function to set up drag and drop for a textarea
    function setupDragDrop(textareaId) {
      const textarea = document.getElementById(textareaId);
      if (!textarea) return;
      textarea.addEventListener("dragover", function(e) {
        e.preventDefault();
      });
      textarea.addEventListener("drop", function(e) {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (!file.type.startsWith("image/")) {
            alert("Only image files are allowed.");
            return;
          }
          const formData = new FormData();
          formData.append("image", file);
          // Use fetch to POST the file to the upload endpoint
          fetch("/upload", {
            method: "POST",
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.url) {
              // Insert the image tag at the end of the textarea content
              textarea.value += `<img src="${data.url}">`;
            } else {
              alert("Image upload failed.");
            }
          })
          .catch(error => {
            console.error("Upload error:", error);
            alert("Image upload error.");
          });
        }
      });
    }

    // Update display for current card
    function renderCard() {
      if (flashcards.length === 0) {
        document.getElementById("flashcard").innerText = "No cards match the filter.";
        document.getElementById("card-info").innerText = "";
        document.getElementById("extra-info").innerText = "";
        return;
      }
      const card = flashcards[currentIndex];
      
      if (editMode) {
        // In edit mode, display textareas for front and back with a Save button.
        document.getElementById("flashcard").innerHTML = `
          <label style="font-size: 1.2em;">Front:</label>
          <textarea id="edit-front" rows="5" style="width:100%;">${card.front}</textarea><br>
          <label style="font-size: 1.2em;">Back:</label>
          <textarea id="edit-back" rows="5" style="width:100%;">${card.back}</textarea><br>
          <button id="save-card-edits">Save Card Edits</button>
        `;
        // Set up drag and drop for the new textareas
        setupDragDrop("edit-front");
        setupDragDrop("edit-back");
        // Attach event listener for the Save Card Edits button.
        document.getElementById("save-card-edits").addEventListener("click", function() {
          flashcards[currentIndex].front = document.getElementById("edit-front").value;
          flashcards[currentIndex].back = document.getElementById("edit-back").value;
          editMode = false; // Exit edit mode after saving
          renderCard();
        });
      } else {
        // In view mode, display normally.
        document.getElementById("flashcard").innerHTML = showingFront ? card.front : card.back;
      }
      
      document.getElementById("card-info").innerText = `Card ${currentIndex + 1} of ${flashcards.length}`;
      document.getElementById("extra-info").innerText = 
        `Importance: ${card.importance} | Current Understanding: ${card.understanding}`;
      document.getElementById("tags-info").innerText = `Tags: ${card.tags.join(", ")}`;
      // Set the sliders to the current card's values (even in edit mode, these remain visible)
      document.getElementById("importance-slider").value = card.importance;
      document.getElementById("importance-value").innerText = card.importance;
      document.getElementById("understanding-slider").value = card.understanding;
      document.getElementById("understanding-value").innerText = card.understanding;
      // Re-typeset math after updating content
      if (window.MathJax) {
        MathJax.typesetPromise();
      }
    }

    // Update importance slider value display
    document.getElementById("importance-slider").addEventListener("input", function(e) {
      document.getElementById("importance-value").innerText = e.target.value;
    });

    // Save the slider value into the current card's importance
    document.getElementById("save-importance").addEventListener("click", function() {
      if (flashcards.length === 0) return;
      flashcards[currentIndex].importance = parseInt(document.getElementById("importance-slider").value);
      renderCard();
    });

    // Update understanding slider value display
    document.getElementById("understanding-slider").addEventListener("input", function(e) {
      document.getElementById("understanding-value").innerText = e.target.value;
    });

    // Save the slider value into the current card's understanding
    document.getElementById("save-understanding").addEventListener("click", function() {
      if (flashcards.length === 0) return;
      flashcards[currentIndex].understanding = parseInt(document.getElementById("understanding-slider").value);
      renderCard();
    });

    // Toggle edit mode when the Edit Card button is clicked
    document.getElementById("toggle-edit").addEventListener("click", function() {
      // Toggling edit mode; unsaved changes will be lost if toggled off without pressing Save Card Edits.
      editMode = !editMode;
      renderCard();
    });

    // Handle navigation via arrow keys and space for flipping
    document.addEventListener('keydown', function(e) {
      // Ignore key events if an input or textarea is focused.
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
        return;
      }
      if (flashcards.length === 0) return;
      if (e.key === "ArrowRight") {
        // Only increment if not at the last card.
        if (currentIndex < flashcards.length - 1) {
          currentIndex++;
          showingFront = true;
          renderCard();
        }
      } else if (e.key === "ArrowLeft") {
        // Only decrement if not at the first card.
        if (currentIndex > 0) {
          currentIndex--;
          showingFront = true;
          renderCard();
        }
      } else if (e.key === " ") {
        // Prevent default space scrolling and flip the card (only in view mode).
        if (!editMode) {
          e.preventDefault();
          showingFront = !showingFront;
          renderCard();
        }
      }
    });

    // Click on card to flip (only in view mode)
    document.getElementById("flashcard").addEventListener("click", function() {
      if (flashcards.length === 0) return;
      if (!editMode) {
        showingFront = !showingFront;
        renderCard();
      }
    });

    // Filtering by tag
    document.getElementById("apply-filter").addEventListener("click", function() {
      const tag = document.getElementById("tag-filter").value.trim().toLowerCase();
      if (tag === "") {
        flashcards = allFlashcards.slice();
      } else {
        flashcards = allFlashcards.filter(card => card.tags.some(t => t.toLowerCase().includes(tag)));
      }
      currentIndex = 0;
      showingFront = true;
      renderCard();
    });

    document.getElementById("clear-filter").addEventListener("click", function() {
      document.getElementById("tag-filter").value = "";
      flashcards = allFlashcards.slice();
      currentIndex = 0;
      showingFront = true;
      renderCard();
    });

    // Initial render
    renderCard();
  </script>
</body>
</html>