<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Perdisco Flashcards Tool</title>
  <!-- Polyfill -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <!-- MathJax configuration -->
  <script>
    window.MathJax = {
      tex: { 
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
  </script>
  <!-- MathJax for LaTeX rendering -->
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: #eef;
      /* Optional: Prevents unwanted scrolling */
      /* overflow: hidden; */
    }
    .flashcard {
      margin: 20px auto;
      padding: 20px;
      border: 2px solid #ccc;
      width: 60%;
      min-height: 300px;
      max-width: 600px;
      text-align: left;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 12px rgba(0,0,0,0.1);
      font-size: 1.35em;
    }
    .flashcard img {
      max-width: 500px;
      max-height: 150px;
    }
    .flashcard textarea {
      width: 100%;
      resize: vertical;
      font-size: 16px;
    }
    #edit-tags { 
      font-family: monospace;
      font-size: 16px;
    }
    #card-info, #extra-info, #tags-info {
      margin-top: 10px;
      font-size: 1.2em;
      color: #555;
    }
    #filter-controls {
      margin: 20px auto;
      width: 100%;
      max-width: 400px;
    }
    #card-controls {
      margin: 20px auto;
      width: 100%;
      max-width: 300px;
    }
    #filter-actions, #edit-actions, #card-info-and-actions {
      margin-bottom: 10px;
    }
    #edit-actions {
      margin-top: 10px;
    }
    #controls input, #controls button {
      font-size: 1em;
      padding: 5px 10px;
      margin: 0 5px;
    }

    /* ===== Top Filtering Controls ===== */
    .filter-table {
      display: table;
      margin: 10px auto;
      width: 100%;
    }

    .filter-row {
      display: table-row;
    }
    
    .filter-cell {
      display: table-cell;
      padding: 5px;
      vertical-align: middle;
      font-size: 1.2em;
      color: #555;
    }

    .filter-buttons-wrapper {
      display: table-cell; /* Ensure it behaves like a full-width table cell */
      width: 100%;
      text-align: center; /* Centers content inside */
    }

    .filter-buttons-inner {
      display: inline-flex; /* Ensures buttons remain centered */
      gap: 10px; /* Adds spacing between buttons */
    }
    .filter-buttons-inner button {
      width: 90px;
      height: 30px
    }
    .edit-buttons-inner {
      display: inline-flex; /* Ensures buttons remain centered */
      gap: 10px; /* Adds spacing between buttons */
    }
    .edit-buttons-inner button {
      width: 90px;
      height: 30px
    }
    
    .card-buttons-outter {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin-top: 10px;
    }

    .card-buttons-inner {
      display: inline-flex; /* Ensures buttons remain centered */
      gap: 10px; /* Adds spacing between buttons */
    }
    .card-buttons-inner button {
      width: 90px;
      height: 30px
    }

    .filter-label {
      text-align: right;
      white-space: nowrap;
    }
    .filter-input {
      width: 100px;
    }
    .filter-value,
    .filter-operator {
      text-align: left;
      padding-left: 10px;
    }

    .filter-value {
      text-align: center;
      padding-left: 10px;
      width: 40px;
    }

    .filter-buttons {
      display: flex !important;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin: 10px auto;
    }
    
    /* ===== Bottom Card Controls ===== */
    .card-table {
      display: table;
      margin: 10px auto;
      width: 100%;
    }
    .card-row {
      display: table-row;
    }
    .card-cell {
      display: table-cell;
      padding: 5px;
      vertical-align: middle;
      font-size: 1.2em;
      color: #555;
    }
    .card-label {
      text-align: right;
      white-space: nowrap;
    }
    .card-input {
      width: 100px;
    }
    .card-value {
      text-align: center;
      padding-left: 10px;
      width: 40px;
    }
    
    /* Ensure MathJax inline math renders inline with the text */
    mjx-container[jax="CHTML"] {
      display: inline !important;
      vertical-align: baseline !important;
      margin: 0 !important;
      padding: 0 !important;
      font-size: 1em !important;
    }
  </style>
</head>
<body>
  <!-- Top Filtering Controls -->
  <div id="filter-controls">
    <div id="filter-actions">
      <div class="filter-table">
        <!-- Row 1: Tag Filter -->
        <div class="filter-row">
          <div class="filter-cell filter-label">
            <label for="tag-filter">Filter by Tag:</label>
          </div>
          <div class="filter-cell filter-input">
            <input type="text" id="tag-filter" placeholder="Enter tag (e.g., 16.32)">
          </div>
          <!-- Empty cells to keep columns consistent -->
          <div class="filter-cell filter-value"></div>
          <div class="filter-cell filter-operator"></div>
        </div>
        <!-- Row 2: Importance Filter -->
        <div class="filter-row">
          <div class="filter-cell filter-label">
            <label for="importance-filter-slider">Importance Filter:</label>
          </div>
          <div class="filter-cell filter-input">
            <input type="range" id="importance-filter-slider" min="1" max="3" value="1">
          </div>
          <div class="filter-cell filter-value" id="importance-filter-value">1</div>
          <div class="filter-cell filter-operator">
            <select id="importance-filter-operator">
              <option value="ge">≥</option>
              <option value="le">≤</option>
            </select>
          </div>
        </div>
        <!-- Row 3: Grok Filter -->
        <div class="filter-row">
          <div class="filter-cell filter-label">
            <label for="grok-filter-slider">Grok Filter:</label>
          </div>
          <div class="filter-cell filter-input">
            <input type="range" id="grok-filter-slider" min="1" max="3" value="3">
          </div>
          <div class="filter-cell filter-value" id="grok-filter-value">3</div>
          <div class="filter-cell filter-operator">
            <select id="grok-filter-operator">
              <option value="le">≤</option>
              <option value="ge">≥</option>
            </select>
          </div>
        </div>
      </div>
      <div class="filter-buttons-inner">
        <button id="apply-filter" style="margin-right: 10px;">Apply Filter</button>
        <button id="clear-filter" style="margin-left: 10px;">Clear Filter</button>
      </div>
    </div>
    <div id="edit-actions">
      <div class="edit-buttons-inner">
        <button id="toggle-edit">Edit Card</button>
        <button id="add-card" style="display: none;">Add +</button>
        <button id="delete-card" style="display: none;">Delete -</button>
      </div>
    </div>
  </div>

  <!-- Flashcard Display -->
  <div class="flashcard" id="flashcard"></div>

  <div id="card-info"></div>
  <div id="extra-info"></div>
  <div id="tags-info"></div>

  <!-- Bottom Card Controls -->
  <div id="card-controls">
    <div class="card-table">
      <!-- Row 1: Importance Slider -->
      <div class="card-row">
        <div class="card-cell card-label">Importance :</div>
        <div class="card-cell card-input">
          <input type="range" id="importance-slider" min="1" max="3" value="2">
        </div>
        <div class="card-cell card-value" id="importance-value">1</div>
      </div>
      <!-- Row 2: Grok Slider -->
      <div class="card-row">
        <div class="card-cell card-label">Grok Level :</div>
        <div class="card-cell card-input">
          <input type="range" id="understanding-slider" min="1" max="3" value="1">
        </div>
        <div class="card-cell card-value" id="understanding-value">1</div>
      </div>
    </div>
  </div>

  <script>
    // Flashcards data passed from Flask
    const allFlashcards = {{ flashcards | tojson }};
    let flashcards = allFlashcards.slice(); // current filtered list
    let currentIndex = 0;
    let showingFront = true;
    let editMode = false; // Variable for edit mode

    // Function to persist flashcards to the server
    function persistFlashcards() {
      fetch("/save", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(flashcards)
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          alert("Failed to save changes.");
        }
      })
      .catch(error => {
        console.error("Persist error:", error);
        alert("Error saving changes.");
      });
    }

    // Function to set up drag and drop for a textarea
    function setupDragDrop(textareaId) {
      const textarea = document.getElementById(textareaId);
      if (!textarea) return;
      textarea.addEventListener("dragover", function(e) {
        e.preventDefault();
      });
      textarea.addEventListener("drop", function(e) {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (!file.type.startsWith("image/")) {
            alert("Only image files are allowed.");
            return;
          }
          const formData = new FormData();
          formData.append("image", file);
          fetch("/upload", {
            method: "POST",
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.url) {
              textarea.value += `<img src="${data.url}">`;
            } else {
              alert("Image upload failed.");
            }
          })
          .catch(error => {
            console.error("Upload error:", error);
            alert("Image upload error.");
          });
        }
      });
    }

    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    // Update display for current card
    function renderCard() {
      if (flashcards.length === 0) {
        document.getElementById("flashcard").innerText = "No cards match the filter.";
        document.getElementById("card-info").innerText = "";
        document.getElementById("extra-info").innerText = "";
        return;
      }
      const card = flashcards[currentIndex];
      
      if (editMode) {
        // In edit mode, display textareas for front, back, and tags with a Save button.
        document.getElementById("flashcard").innerHTML = `
          <label style="font-size: 1.2em;">Front:</label>
          <textarea id="edit-front" rows="5" style="width:100%; resize: vertical; overflow: hidden;">${card.front}</textarea><br>
          <label style="font-size: 1.2em;">Back:</label>
          <textarea id="edit-back" rows="5" style="width:100%; resize: vertical; overflow: hidden;">${card.back}</textarea><br>
          <label style="font-size: 1.2em;">Tags:</label>
          <input type="text" id="edit-tags" style="width:100%;" value="${card.tags.join(', ')}"><br>
          <div class="card-buttons-outter">
            <div class="card-buttons-inner">
              <button id="save-card-edits">Save Edits</button>
            </div>
          </div>
        `;
        setupDragDrop("edit-front");
        setupDragDrop("edit-back");
        
        // Set up auto-resize for the textareas in edit mode.
        const frontTextarea = document.getElementById("edit-front");
        const backTextarea = document.getElementById("edit-back");

        // Define a function that resets the textarea height to 'auto' then sets it to its scrollHeight.
        function autoResizeTextarea(textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Attach the auto-resize function to the input events so the height adjusts as the user types.
        frontTextarea.addEventListener("input", function() {
          autoResizeTextarea(frontTextarea);
        });
        backTextarea.addEventListener("input", function() {
          autoResizeTextarea(backTextarea);
        });

        // Immediately adjust the height to fit the initial content.
        autoResizeTextarea(frontTextarea);
        autoResizeTextarea(backTextarea);
        
        document.getElementById("save-card-edits").addEventListener("click", function() {
          flashcards[currentIndex].front = document.getElementById("edit-front").value;
          flashcards[currentIndex].back = document.getElementById("edit-back").value;
          flashcards[currentIndex].tags = document.getElementById("edit-tags").value.split(',')
            .map(tag => tag.trim())
            .filter(tag => tag.length > 0);
          editMode = false;
          // When exiting edit mode, force front view.
          showingFront = true;
          document.getElementById("add-card").style.display = "none";
          document.getElementById("delete-card").style.display = "none";
          document.getElementById("toggle-edit").innerText = "Edit Card";
          persistFlashcards();
          renderCard();
        });
        
      } else {
        // In view mode, display based on showingFront.
        document.getElementById("flashcard").innerHTML = showingFront ? card.front : card.back;
      }
      
      document.getElementById("card-info").innerText = `Card ${currentIndex + 1} of ${flashcards.length}`;
      document.getElementById("tags-info").innerText = `Tags: ${card.tags.join(", ")}`;
      document.getElementById("importance-slider").value = card.importance;
      document.getElementById("importance-value").innerText = card.importance;
      document.getElementById("understanding-slider").value = card.understanding;
      document.getElementById("understanding-value").innerText = card.understanding;
      if (window.MathJax) {
        if (typeof MathJax.typesetPromise === "function") {
          MathJax.typesetPromise();
        } else if (typeof MathJax.typeset === "function") {
          MathJax.typeset();
        }
      }
    }

    // NEW: Update displayed values for filtering sliders.
    document.getElementById("importance-filter-slider").addEventListener("input", function(e) {
      document.getElementById("importance-filter-value").innerText = e.target.value;
    });
    document.getElementById("grok-filter-slider").addEventListener("input", function(e) {
      document.getElementById("grok-filter-value").innerText = e.target.value;
    });

    // Importance slider: update display on input, save on change.
    document.getElementById("importance-slider").addEventListener("input", function(e) {
      document.getElementById("importance-value").innerText = e.target.value;
    });
    document.getElementById("importance-slider").addEventListener("change", function(e) {
      const value = parseInt(e.target.value);
      flashcards[currentIndex].importance = value;
      persistFlashcards();
      renderCard();
    });

    // Understanding slider: update display on input, save on change.
    document.getElementById("understanding-slider").addEventListener("input", function(e) {
      document.getElementById("understanding-value").innerText = e.target.value;
    });
    document.getElementById("understanding-slider").addEventListener("change", function(e) {
      const value = parseInt(e.target.value);
      flashcards[currentIndex].understanding = value;
      persistFlashcards();
      renderCard();
    });

    document.getElementById("toggle-edit").addEventListener("click", function() {
      editMode = !editMode;
      if (!editMode) {
        // When exiting edit mode, ensure we show the front.
        showingFront = true;
      }
      document.getElementById("toggle-edit").innerText = editMode ? "Exit Edit" : "Edit Card";
      document.getElementById("add-card").style.display = editMode ? "inline-block" : "none";
      document.getElementById("delete-card").style.display = editMode ? "inline-block" : "none";
      renderCard();
    });

    document.getElementById("add-card").addEventListener("click", function() {
      const newCard = {
        "front": "TODO: New front content",
        "back": "TODO: New back content",
        "tags": [
          "18.0651"  // default tag
        ],
        "importance": 2,
        "understanding": 1
      };
      flashcards.splice(currentIndex + 1, 0, newCard);
      currentIndex++;
      persistFlashcards();
      renderCard();
    });

    document.getElementById("delete-card").addEventListener("click", function() {
      if (flashcards.length === 0) return;
      flashcards.splice(currentIndex, 1);
      if (currentIndex >= flashcards.length) {
        currentIndex = flashcards.length - 1;
      }
      if (flashcards.length === 0) {
        document.getElementById("flashcard").innerText = "No cards available.";
        document.getElementById("card-info").innerText = "";
        document.getElementById("extra-info").innerText = "";
        // document.getElementById("tags-info").innerText = "";
        persistFlashcards();
        return;
      }
      persistFlashcards();
      renderCard();
    });

    document.addEventListener('keydown', function(e) {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
        return;
      }
      
      if (e.key === "e" || (editMode && e.key === "Escape")) {
        editMode = !editMode;
        document.getElementById("toggle-edit").innerText = editMode ? "Exit Edit" : "Edit Card";
        document.getElementById("add-card").style.display = editMode ? "inline-block" : "none";
        document.getElementById("delete-card").style.display = editMode ? "inline-block" : "none";
        renderCard();
        return;
      }
      
      if (e.key === "s" && editMode) {
        const saveButton = document.getElementById("save-card-edits");
        if (saveButton) {
          saveButton.click();
        }
        return;
      }
      
      if (flashcards.length === 0) return;
      if (e.key === "ArrowRight" || e.key === "d") {
        if (currentIndex < flashcards.length - 1) {
          currentIndex++;
          showingFront = true;
          renderCard();
        }
      } else if (e.key === "ArrowLeft" || e.key === "a") {
        if (currentIndex > 0) {
          currentIndex--;
          showingFront = true;
          renderCard();
        }
      } else if (e.key === " " || e.key === "w" || e.key === "ArrowUp" || e.key === "ArrowDown") {
        if (!editMode) {
          e.preventDefault();
          showingFront = !showingFront;
          renderCard();
        }
      }
    });

    document.getElementById("flashcard").addEventListener("click", function() {
      if (flashcards.length === 0) return;
      if (!editMode) {
        showingFront = !showingFront;
        renderCard();
      }
    });

    document.getElementById("apply-filter").addEventListener("click", function() {
      let filteredCards = allFlashcards.slice();

      // Tag filtering: split the input into an array of filter tags.
      const tagInput = document.getElementById("tag-filter").value.trim().toLowerCase();
      if (tagInput !== "") {
        const filterTags = tagInput.split(",").map(tag => tag.trim()).filter(tag => tag !== "");
        filteredCards = filteredCards.filter(card => {
          // Map card tags to lowercase for case-insensitive matching.
          const cardTags = card.tags.map(tag => tag.toLowerCase());
          // Check that every filter tag is included in the card's tags.
          return filterTags.every(filterTag => cardTags.includes(filterTag));
        });
      }

      // Additional filtering: Importance level.
      const impValue = parseInt(document.getElementById("importance-filter-slider").value);
      const impOperator = document.getElementById("importance-filter-operator").value; // "ge" or "le"
      if (impOperator === "ge") {
        filteredCards = filteredCards.filter(card => card.importance >= impValue);
      } else {
        filteredCards = filteredCards.filter(card => card.importance <= impValue);
      }

      // Additional filtering: Grok (understanding) level.
      const grokValue = parseInt(document.getElementById("grok-filter-slider").value);
      const grokOperator = document.getElementById("grok-filter-operator").value; // "le" or "ge"
      if (grokOperator === "le") {
        filteredCards = filteredCards.filter(card => card.understanding <= grokValue);
      } else {
        filteredCards = filteredCards.filter(card => card.understanding >= grokValue);
      }

      flashcards = filteredCards;
      currentIndex = 0;
      renderCard();
    });

    document.getElementById("clear-filter").addEventListener("click", function() {
      document.getElementById("tag-filter").value = "";
      flashcards = allFlashcards.slice();
      currentIndex = 0;
      renderCard();
    });

    renderCard();
  </script>
</body>
</html>